<!--
    Smart GEDCOM Merger (No Duplicates)
    This tool merges multiple GEDCOM files while removing duplicate individuals.
    It normalizes names by stripping slashes and ignoring case to identify duplicates.

 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart GEDCOM Merger (No Duplicates)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; }
        .box { border: 3px solid #28a745; padding: 30px; border-radius: 15px; background: #f9fff9; text-align: center; }
        button { background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 15px; font-weight: bold; }
        #log { margin-top: 20px; text-align: left; font-size: 12px; background: #333; color: #fff; padding: 15px; max-height: 250px; overflow-y: auto; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2>Smart Content Merger</h2>
    <p>This version strips slashes and ignores case to find and <b>merge</b> duplicate people.</p>
    <input type="file" id="fileInput" multiple accept=".ged">
    <br>
    <button id="mergeBtn">Merge & Remove Duplicates</button>
    <div id="status" style="margin-top:10px;">Ready.</div>
    <div id="log" style="display:none;"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const mergeBtn = document.getElementById('mergeBtn');
    const status = document.getElementById('status');
    const log = document.getElementById('log');

    // Cleans "Gil /Rimon/" into "gil rimon" for matching
    function normalizeName(record) {
        const match = record.match(/1 NAME (.*)/);
        if (!match) return null;
        return match[1].replace(/\//g, '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    mergeBtn.addEventListener('click', async () => {
        const files = Array.from(fileInput.files);
        if (files.length < 2) return alert("Select at least two files.");

        status.innerText = "Merging records...";
        log.style.display = "block";
        log.innerHTML = "<b>Merge Log:</b><br>";
        
        let peopleMap = new Map(); 
        let families = new Set(); 
        let header = "0 HEAD\n1 GEDC\n2 VERS 5.5.1\n2 FORM LINEAGE-LINKED\n1 CHAR UTF-8\n1 SOUR SMART_MERGER_V2\n";

        for (let file of files) {
            let text = await file.text();
            
            // Fix formatting errors first
            text = text.replace(/^0\s+(I\d+|X\d+)\s+INDI/gm, '0 @$1@ INDI')
                       .replace(/^1\s+(FAMS|FAMC|CHIL|HUSB|WIFE)\s+(I\d+|F\d+|X\d+)/gm, '1 $1 @$2@')
                       .replace(/^0\s+(F\d+)\s+FAM/gm, '0 @$1@ FAM');

            const blocks = text.split(/\n(?=0\s+@)/);

            blocks.forEach(block => {
                if (block.includes('INDI')) {
                    const cleanName = normalizeName(block);
                    if (cleanName) {
                        if (peopleMap.has(cleanName)) {
                            log.innerHTML += `Matched & Combined: ${cleanName}<br>`;
                            // Merge facts: Combine the lines from both records, then remove duplicate lines
                            let combined = (peopleMap.get(cleanName) + "\n" + block).split('\n');
                            let uniqueLines = [...new Set(combined.map(l => l.trim()))];
                            peopleMap.set(cleanName, uniqueLines.join('\n'));
                        } else {
                            peopleMap.set(cleanName, block.trim());
                        }
                    }
                } else if (block.includes('FAM')) {
                    families.add(block.trim());
                }
            });
        }

        const finalFile = `${header}\n${Array.from(peopleMap.values()).join('\n')}\n${Array.from(families).join('\n')}\n0 TRLR`;
        const blob = new Blob([finalFile], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "no_duplicates_tree.ged";
        a.click();
        
        status.innerText = "Success! Duplicates merged.";
    });
</script>

</body>
</html>